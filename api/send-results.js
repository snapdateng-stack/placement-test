import { Resend } from 'resend';

const resend = new Resend(process.env.RESEND_API_KEY);

export default async function handler(request, response) {
  if (request.method !== 'POST') {
    return response.status(405).json({ error: 'Method not allowed' });
  }

  try {
    const { studentInfo, results, placement, writingAnswers, aiFeedback } = await request.json();
    
    console.log('Sending email for student:', studentInfo?.name);
    
    await sendEmail(studentInfo, results, placement, writingAnswers, aiFeedback);
    return response.status(200).json({ message: 'Email sent successfully' });
  } catch (error) {
    console.error('Email sending error:', error);
    return response.status(500).json({ error: 'Failed to send email: ' + error.message });
  }
}

async function sendEmail(studentInfo, results, placement, writingAnswers, aiFeedback) {
  const emailHtml = `
    <h1>New English Placement Test Result</h1>
    
    <h2>Student Information</h2>
    <p><strong>Name:</strong> ${studentInfo.name}</p>
    <p><strong>Email:</strong> ${studentInfo.email}</p>
    <p><strong>Age:</strong> ${studentInfo.age || 'Not provided'}</p>
    <p><strong>Native Language:</strong> ${studentInfo.nativeLanguage || 'Not provided'}</p>
    <p><strong>Test Date:</strong> ${new Date().toLocaleString()}</p>
    
    <h2>Test Results</h2>
    <p><strong>Total Score:</strong> ${results.totalScore}/${results.maxScore} (${results.percentage}%)</p>
    <p><strong>Placement Level:</strong> ${placement.level}</p>
    
    <h3>Section Breakdown</h3>
    <ul>
      <li><strong>Listening:</strong> ${results.listening.score}/${results.listening.max}</li>
      <li><strong>Grammar:</strong> ${results.grammar.score}/${results.grammar.max}</li>
      <li><strong>Reading:</strong> ${results.reading.score}/${results.reading.max}</li>
    </ul>
    
    <h2>Writing Tasks</h2>
    
    <h3>Task 1: Daily Routine</h3>
    <div style="background: #f5f5f5; padding: 15px; border-radius: 5px;">
      ${writingAnswers.writing1 || 'Not completed'}
    </div>
    
    <h3>Task 2: Opinion Essay</h3>
    <div style="background: #f5f5f5; padding: 15px; border-radius: 5px;">
      ${writingAnswers.writing2 || 'Not completed'}
    </div>
    
    ${aiFeedback ? `
    <h2>AI Assessment</h2>
    <div style="background: #fff3cd; padding: 15px; border-radius: 5px;">
      <pre style="white-space: pre-wrap;">${JSON.stringify(aiFeedback, null, 2)}</pre>
    </div>
    ` : ''}
    
    <hr>
    <p><em>This email was automatically generated by the English Placement Test system.</em></p>
  `;
  
  await resend.emails.send({
    from: 'English Test <onboarding@resend.dev>',
    to: 'snapdateng@gmail.com',
    subject: `English Test Results - ${studentInfo.name}`,
    html: emailHtml,
  });
}
